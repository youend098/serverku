#!/bin/bash
# ================================================
# FIXED LXD INSTALLATION SCRIPT FOR DEBIAN 12
# ================================================

# Show banner
echo -e "\033[1;34m"  # Biru terang
echo " â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— "
echo " â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•    â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—"
echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—       â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘"
echo " â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•        â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘"
echo " â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘            â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
echo " â•šâ•â•     â•šâ•â•â•šâ•â•            â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â• "
echo -e "\033[0m"
echo -e "\033[1;32m>> Starting the virtual scrypt installation...\033[0m"
sleep 2

# --- [1] HAPUS SNAP LAMA ---
echo "ğŸ§¹ Membersihkan snap yang bermasalah..."
sudo systemctl stop snapd
sudo apt purge -y snapd
sudo rm -rf /var/snap /snap /var/lib/snapd

# --- [2] INSTALL SNAP YANG FRESH ---
echo "ğŸ”„ Menginstall ulang snapd..."
sudo apt update
sudo apt install -y snapd
sudo systemctl start snapd
sudo systemctl enable snapd

# Tunggu sampai snapd benar-benar ready
sleep 10

# --- [3] UPDATE SNAPD ---
echo "ğŸ†™ Memperbarui snapd core..."
sudo snap install core
sudo snap refresh core

# --- [4] INSTALL LXD ---
echo "ğŸ³ Menginstall LXD..."
sudo snap install lxd --channel=latest/stable
sudo snap refresh lxd --channel=latest/stable

# --- [5] INISIALISASI LXD ---
echo "ğŸ”§ Inisialisasi LXD..."

# Pastikan service LXD aktif
sudo snap start lxd

# Tunggu sampai LXD benar-benar ready
timeout=30
while [ $timeout -gt 0 ]; do
    if sudo lxd waitready; then
        break
    fi
    echo "â³ Menunggu LXD ready... (sisa waktu: $timeout detik)"
    sleep 1
    ((timeout--))
done

if [ $timeout -eq 0 ]; then
    echo "âš ï¸ LXD tidak ready dalam waktu yang ditentukan, restarting service..."
    sudo snap restart lxd
    sleep 10
fi

# Jalankan inisialisasi
sudo lxd init --auto --storage-backend=dir

# Verifikasi socket
echo "ğŸ” Memverifikasi socket LXD..."
if [ ! -S /var/snap/lxd/common/lxd/unix.socket ]; then
    echo "âš ï¸ Socket LXD tidak ditemukan, restarting service..."
    sudo snap restart lxd
    sleep 10
fi

# --- [6] KONFIGURASI USER ---
echo "ğŸ‘¤ Konfigurasi user..."
sudo usermod -aG lxd $USER
newgrp lxd <<EONG
echo "âœ… LXD siap digunakan"
lxc list
EONG

# --- [7] VERIFIKASI ---
echo "ğŸ” Verifikasi instalasi..."
sudo lxc info
lxc list

# --- [8] BUAT CONTAINER ---
echo "ğŸš€ Membuat container Ubuntu 20.04..."
lxc launch ubuntu:20.04 ubuntu20
lxc exec ubuntu20 -- apt update && lxc exec ubuntu20 -- apt upgrade -y

cat <<EOF

âœ… INSTALASI BERHASIL!
       LANGKAH SELANJUTNYA
          reboot dulu vpsnya...
EOF
